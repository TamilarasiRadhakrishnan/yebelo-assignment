import fs from "fs";
import { parse } from "csv-parse";
import { Kafka } from "kafkajs";

const brokers = [process.env.KAFKA_BROKER || "localhost:9092"];
const kafka = new Kafka({ brokers });
const producer = kafka.producer();

async function run() {
  await producer.connect();
  const parser = fs.createReadStream("./trades_data.csv").pipe(parse({ columns: true, skip_empty_lines: true }));

  for await (const record of parser) {
    const msg = {
      token_address: record.token_address || record.token || "unknown",
      price_in_sol: parseFloat(record.price_in_sol || record.price || "0"),
      block_time: record.block_time || new Date().toISOString(),
      raw: record
    };

    await producer.send({
      topic: "trade-data",
      messages: [{ key: msg.token_address, value: JSON.stringify(msg) }]
    });

    // small pause to simulate streaming
    await new Promise(r => setTimeout(r, 50));
  }

  console.log("Finished sending CSV rows");
  await producer.disconnect();
}

run().catch(err => { console.error(err); process.exit(1); });
